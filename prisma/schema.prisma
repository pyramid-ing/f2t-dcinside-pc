generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Settings {
  id        Int      @id @default(autoincrement())
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ê¸°ë³¸ Job ëª¨ë¸
model Job {
  id String @id @default(cuid())

  type      String
  subject   String? // ì‘ì—… ì œëª©
  desc      String? // ì‘ì—… ì„¤ëª…
  status    String  @default("pending") // JobStatus: 'request' | 'pending' | 'processing' | 'completed' | 'failed'
  priority  Int     @default(1)
  resultMsg String? // ê²°ê³¼ ë©”ì‹œì§€
  errorMsg  String? // ì—ëŸ¬ ë©”ì‹œì§€

  scheduledAt DateTime
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // ë¡œê·¸
  logs JobLog[]

  // ë¸”ë¡œê·¸ ì‘ì—… ê´€ë ¨ ë°ì´í„°
  postJob PostJob?

  // ëŒ“ê¸€ ì‘ì—… ê´€ë ¨ ë°ì´í„°
  commentJob CommentJob?

  // ì¿ íŒŒìŠ¤ ì‘ì—… ê´€ë ¨ ë°ì´í„°
  coupasJob CoupasJob?
}

model JobLog {
  id String @id @default(cuid())

  message String
  level   String @default("info") // 'info' | 'warn' | 'error'

  createdAt DateTime @default(now())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}

model PostJob {
  id String @id @default(uuid())

  galleryUrl         String
  title              String
  contentHtml        String
  password           String?
  nickname           String?
  headtext           String?
  imagePaths         String? // JSON stringified array
  loginId            String?
  loginPassword      String?
  imagePosition      String? // 'ìƒë‹¨' ë˜ëŠ” 'í•˜ë‹¨'
  resultUrl          String? // ê²°ê³¼ URL
  deleteAt           DateTime?
  deletedAt          DateTime?
  autoDeleteMinutes  Int? // ë“±ë¡í›„ìë™ì‚­ì œ(ë¶„)
  viewCount          Int? // ì¡°íšŒìˆ˜
  viewCountUpdatedAt DateTime? // ì¡°íšŒìˆ˜ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
  comment            String? // ê²Œì‹œê¸€ ë“±ë¡ í›„ ìë™ ëŒ“ê¸€ ë“±ë¡ìš©

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobId String @unique // Job ëª¨ë¸ê³¼ 1:1 ê´€ê³„
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model CommentJob {
  id String @id @default(uuid())

  keyword       String
  comment       String
  postUrl       String // ë‹¨ì¼ í¬ìŠ¤íŠ¸ URL
  postTitle     String // í¬ìŠ¤íŠ¸ ì œëª©
  galleryId     String  @default("unknown") // ê°¤ëŸ¬ë¦¬ ID (ì˜ˆ: programming, baseball_new10)
  nickname      String?
  password      String?
  loginId       String?
  loginPassword String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobId String @unique // Job ëª¨ë¸ê³¼ 1:1 ê´€ê³„
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([galleryId])
}

model CoupasJob {
  id String @id @default(uuid())

  postUrl           String // ë””ì‹œì¸ì‚¬ì´ë“œ í¬ìŠ¤íŠ¸ URL
  wordpressUrl      String // ì›Œë“œí”„ë ˆìŠ¤ ì‚¬ì´íŠ¸ URL
  wordpressUsername String // ì›Œë“œí”„ë ˆìŠ¤ ì‚¬ìš©ìëª…
  wordpressApiKey   String // ì›Œë“œí”„ë ˆìŠ¤ API í‚¤

  // ëŒ“ê¸€ ì‘ì„± ê´€ë ¨ í•„ë“œ
  nickname      String? // ë¹„íšŒì› ë‹‰ë„¤ì„
  password      String? // ë¹„íšŒì› ë¹„ë°€ë²ˆí˜¸
  loginId       String? // íšŒì› ë¡œê·¸ì¸ ID
  loginPassword String? // íšŒì› ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸

  resultBlogLink String? // ìƒì„±ëœ ë¸”ë¡œê·¸ ë§í¬
  resultComment  String? // ìƒì„±ëœ ëŒ“ê¸€ í…ìŠ¤íŠ¸

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobId String @unique // Job ëª¨ë¸ê³¼ 1:1 ê´€ê³„
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

// ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ê°¤ëŸ¬ë¦¬
model MonitoredGallery {
  id String @id @default(uuid())

  type       String  @default("gallery") // 'gallery' | 'search'
  actionType String? // 'coupas' | 'fixed_comment' (nullable: ì„¤ì •ë˜ì§€ ì•Šìœ¼ë©´ ì‘ì—… ìƒì„± ì•ˆí•¨)

  galleryUrl  String  @unique // ê°¤ëŸ¬ë¦¬ URL
  galleryId   String // ê°¤ëŸ¬ë¦¬ ID (ì˜ˆ: programming)
  galleryName String? // ê°¤ëŸ¬ë¦¬ ì´ë¦„
  commentText String? // ì´ ê°¤ëŸ¬ë¦¬ì— ë‹¬ ëŒ“ê¸€ ë‚´ìš© (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
  isActive    Boolean @default(true) // í™œì„±í™” ì—¬ë¶€

  // ê²€ìƒ‰ íƒ€ì… ì „ìš© í•„ë“œ
  searchKeyword String? // ê²€ìƒ‰ í‚¤ì›Œë“œ (search íƒ€ì…ìš©)
  searchSort    String? @default("latest") // 'latest' | 'accuracy' (search íƒ€ì…ìš©)

  // AI ì í•©ì„± ê²€ì‚¬ (coupas íƒ€ì…ìš©)
  aiPromptCode String? // AI í”„ë¡¬í”„íŠ¸ ì½”ë“œëª… (ì˜ˆ: 'product-recommendation', 'tech-advice')

  // ë¡œê·¸ì¸ ì •ë³´
  loginId       String? // íšŒì› ë¡œê·¸ì¸ ID
  loginPassword String? // íšŒì› ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸
  nickname      String? // ë¹„íšŒì› ë‹‰ë„¤ì„
  password      String? // ë¹„íšŒì› ë¹„ë°€ë²ˆí˜¸

  lastCheckedAt DateTime? // ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // ë°œê²¬ëœ ê²Œì‹œê¸€ë“¤
  posts MonitoredPost[]

  @@index([isActive])
  @@index([type])
  @@index([actionType])
}

// ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê°¤ëŸ¬ë¦¬ (ëª¨ë‹ˆí„°ë§ì—ì„œ ì œì™¸í•  ê°¤ëŸ¬ë¦¬)
model BlacklistedGallery {
  id String @id @default(uuid())

  galleryUrl  String  @unique // ê°¤ëŸ¬ë¦¬ URL (unique key)
  galleryId   String // ê°¤ëŸ¬ë¦¬ ID (ì˜ˆ: programming)
  galleryName String? // ê°¤ëŸ¬ë¦¬ ì´ë¦„
  remarks     String? // ë¹„ê³ 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([galleryId])
}

// AI ê²€ì¦ ìƒíƒœ
enum ApprovedStatus {
  PENDING // ê²€ì‚¬ ëŒ€ê¸°
  PROCESSING // ê²€ì‚¬ ì§„í–‰ ì¤‘
  APPROVED // ìŠ¹ì¸ë¨
  REJECTED // ê±°ë¶€ë¨
  FAILED // ì—ëŸ¬ ë°œìƒ
}

// ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ë°œê²¬ëœ ê²Œì‹œê¸€
model MonitoredPost {
  id String @id @default(uuid())

  postUrl    String    @unique // ê²Œì‹œê¸€ URL (unique key)
  postTitle  String // ê²Œì‹œê¸€ ì œëª©
  postId     String // ê²Œì‹œê¸€ ID
  headtext   String? // ë§ë¨¸ë¦¬ (ì¼ë°˜, ğŸ¬ì˜ìƒ, ğŸ–¼ï¸ì‚¬ì§„ ë“±)
  authorName String? // ì‘ì„±ì
  answered   Boolean   @default(false) // ëŒ“ê¸€ ë‹¬ì•˜ëŠ”ì§€ ì—¬ë¶€
  answeredAt DateTime? // ëŒ“ê¸€ ë‹¨ ì‹œê°

  // AI ì í•©ì„± ê²€ì‚¬ ê²°ê³¼
  approvedStatus ApprovedStatus @default(PENDING) // AI ê²€ì¦ ìƒíƒœ
  aiReason       String? // AI íŒë‹¨ ì´ìœ 

  galleryId String
  gallery   MonitoredGallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([galleryId, answered])
  @@index([answered])
  @@index([approvedStatus])
}
